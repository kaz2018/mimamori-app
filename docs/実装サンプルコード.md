# Gemini ADK & Vertex AI å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

## ğŸš€ Cloud Functions å®Ÿè£…

### 1. Gemini ADK ã§ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆ

```python
# functions/story_generation.py
import functions_framework
import vertexai
from vertexai.generative_models import GenerativeModel
import json
import re

# Vertex AI åˆæœŸåŒ–
vertexai.init(project="your-project-id", location="us-central1")

@functions_framework.http
def generate_story(request):
    """Gemini ADKã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆ"""
    
    # CORS ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
    headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST',
        'Access-Control-Allow-Headers': 'Content-Type',
    }
    
    if request.method == 'OPTIONS':
        return ('', 204, headers)
    
    try:
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—
        request_json = request.get_json()
        user_topic = request_json.get('topic', 'å†’é™º')
        
        # Gemini Pro ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–
        model = GenerativeModel("gemini-1.5-pro")
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
        prompt = create_story_prompt(user_topic)
        
        # ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆ
        response = model.generate_content(
            prompt,
            generation_config={
                "temperature": 0.8,
                "top_p": 0.8,
                "top_k": 40,
                "max_output_tokens": 2048,
            }
        )
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
        story_data = parse_story_response(response.text)
        
        return (json.dumps(story_data, ensure_ascii=False), 200, headers)
        
    except Exception as e:
        error_response = {
            'error': str(e),
            'fallback_story': get_fallback_story(user_topic)
        }
        return (json.dumps(error_response, ensure_ascii=False), 500, headers)

def create_story_prompt(user_topic):
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ"""
    
    return f"""
ã‚ãªãŸã¯å¹¼ç¨šåœ’å…ï¼ˆ3-6æ­³ï¼‰å‘ã‘ã®ç‰©èªä½œå®¶ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§ç‰©èªã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

ã€ãŠé¡Œã€‘{user_topic}

ã€æ¡ä»¶ã€‘
- å¯¾è±¡å¹´é½¢ï¼š3-6æ­³ï¼ˆã²ã‚‰ãŒãªå¤šã‚ã€å„ªã—ã„è¡¨ç¾ï¼‰
- æ§‹é€ ï¼šå°å…¥ â†’ 2æŠåˆ†å² â†’ 2æŠåˆ†å² â†’ 4ã¤ã®çµæœ«
- å…¨çµæœ«ï¼šå¿…ãšãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰
- å„æ®µè½ï¼š50-80æ–‡å­—ç¨‹åº¦
- æ•™è‚²çš„ä¾¡å€¤ï¼šå‹æƒ…ã€å„ªã—ã•ã€å‹‡æ°—ã€å”åŠ›ãªã©ã®ãƒ†ãƒ¼ãƒ
- å®‰å…¨æ€§ï¼šæ€–ã„è¦ç´ ãªã—ã€å¹´é½¢é©æ­£ãªå†…å®¹

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§ä»¥ä¸‹ã®æ§‹é€ ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

```json
{{
  "title": "ç‰©èªã®ã‚¿ã‚¤ãƒˆãƒ«",
  "introduction": "å°å…¥éƒ¨åˆ†ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä¸»äººå…¬ç´¹ä»‹ã¨çŠ¶æ³è¨­å®šï¼‰",
  "first_choice": {{
    "situation": "æœ€åˆã®é¸æŠå ´é¢ã®èª¬æ˜",
    "option_a": "é¸æŠè‚¢Aï¼ˆçµµæ–‡å­—ä»˜ãï¼‰",
    "option_b": "é¸æŠè‚¢Bï¼ˆçµµæ–‡å­—ä»˜ãï¼‰"
  }},
  "branches": {{
    "a": {{
      "story": "é¸æŠè‚¢Aã‚’é¸ã‚“ã å ´åˆã®å±•é–‹",
      "second_choice": {{
        "situation": "2å›ç›®ã®é¸æŠå ´é¢ã®èª¬æ˜",
        "option_a": "é¸æŠè‚¢A-Aï¼ˆçµµæ–‡å­—ä»˜ãï¼‰",
        "option_b": "é¸æŠè‚¢A-Bï¼ˆçµµæ–‡å­—ä»˜ãï¼‰"
      }}
    }},
    "b": {{
      "story": "é¸æŠè‚¢Bã‚’é¸ã‚“ã å ´åˆã®å±•é–‹",
      "second_choice": {{
        "situation": "2å›ç›®ã®é¸æŠå ´é¢ã®èª¬æ˜",
        "option_a": "é¸æŠè‚¢B-Aï¼ˆçµµæ–‡å­—ä»˜ãï¼‰",
        "option_b": "é¸æŠè‚¢B-Bï¼ˆçµµæ–‡å­—ä»˜ãï¼‰"
      }}
    }}
  }},
  "endings": {{
    "aa": {{
      "story": "çµæœ«A-Aï¼ˆãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ã€å­¦ã³ã®ã‚ã‚‹çµè«–ï¼‰",
      "lesson": "ã“ã®çµæœ«ã‹ã‚‰å­¦ã¹ã‚‹ã“ã¨",
      "image_prompt": "A happy children's book illustration showing [å…·ä½“çš„ãªå ´é¢æå†™ in English]"
    }},
    "ab": {{
      "story": "çµæœ«A-Bï¼ˆãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ã€å­¦ã³ã®ã‚ã‚‹çµè«–ï¼‰",
      "lesson": "ã“ã®çµæœ«ã‹ã‚‰å­¦ã¹ã‚‹ã“ã¨",
      "image_prompt": "A joyful children's book scene depicting [å…·ä½“çš„ãªå ´é¢æå†™ in English]"
    }},
    "ba": {{
      "story": "çµæœ«B-Aï¼ˆãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ã€å­¦ã³ã®ã‚ã‚‹çµè«–ï¼‰",
      "lesson": "ã“ã®çµæœ«ã‹ã‚‰å­¦ã¹ã‚‹ã“ã¨",
      "image_prompt": "A cheerful children's illustration featuring [å…·ä½“çš„ãªå ´é¢æå†™ in English]"
    }},
    "bb": {{
      "story": "çµæœ«B-Bï¼ˆãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ã€å­¦ã³ã®ã‚ã‚‹çµè«–ï¼‰",
      "lesson": "ã“ã®çµæœ«ã‹ã‚‰å­¦ã¹ã‚‹ã“ã¨",
      "image_prompt": "A delightful children's book image showing [å…·ä½“çš„ãªå ´é¢æå†™ in English]"
    }}
  }}
}}
```

é‡è¦ï¼šå¿…ãšJSONã®ã¿ã‚’å‡ºåŠ›ã—ã€ä½™è¨ˆãªãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚
"""

def parse_story_response(response_text):
    """Geminiã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æã—ã¦JSONãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º"""
    
    try:
        # JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
        json_match = re.search(r'```json\s*(\{.*?\})\s*```', response_text, re.DOTALL)
        if json_match:
            json_str = json_match.group(1)
        else:
            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: å…¨ä½“ã‚’JSONã¨ã—ã¦è§£æè©¦è¡Œ
            json_str = response_text.strip()
        
        # JSONè§£æ
        story_data = json.loads(json_str)
        
        # ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
        validate_story_data(story_data)
        
        return story_data
        
    except Exception as e:
        print(f"JSONè§£æã‚¨ãƒ©ãƒ¼: {e}")
        raise Exception(f"ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

def validate_story_data(story_data):
    """ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼"""
    
    required_keys = ['title', 'introduction', 'first_choice', 'branches', 'endings']
    
    for key in required_keys:
        if key not in story_data:
            raise Exception(f"å¿…é ˆã‚­ãƒ¼ '{key}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # åˆ†å²æ•°æ¤œè¨¼
    if len(story_data['branches']) != 2:
        raise Exception("åˆ†å²ã¯2ã¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
    
    # çµæœ«æ•°æ¤œè¨¼
    if len(story_data['endings']) != 4:
        raise Exception("çµæœ«ã¯4ã¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
    
    # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå­˜åœ¨ç¢ºèª
    for ending_key, ending_data in story_data['endings'].items():
        if 'image_prompt' not in ending_data:
            raise Exception(f"çµæœ« {ending_key} ã«ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Šã¾ã›ã‚“")

def get_fallback_story(user_topic):
    """ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼"""
    
    return {
        "title": f"{user_topic}ã®ãŠè©±",
        "introduction": "ç´ æ•µãªå†’é™ºãŒå§‹ã¾ã‚Šã¾ã™ã€‚",
        "first_choice": {
            "situation": "ã©ã¡ã‚‰ã®é“ã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ",
            "option_a": "ğŸŒ¸ æ˜ã‚‹ã„é“",
            "option_b": "ğŸŒŸ ä¸æ€è­°ãªé“"
        },
        "branches": {
            "a": {
                "story": "æ˜ã‚‹ã„é“ã§ã¯æ–°ã—ã„å‹é”ã«å‡ºä¼šã„ã¾ã—ãŸã€‚",
                "second_choice": {
                    "situation": "å‹é”ã¨ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ",
                    "option_a": "ğŸˆ ä¸€ç·’ã«éŠã¶",
                    "option_b": "ğŸ­ ãŠã‚„ã¤ã‚’åˆ†ã‘ã‚‹"
                }
            },
            "b": {
                "story": "ä¸æ€è­°ãªé“ã§ã¯é­”æ³•ã®å…‰ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚",
                "second_choice": {
                    "situation": "å…‰ã‚’ã©ã†ã—ã¾ã™ã‹ï¼Ÿ",
                    "option_a": "âœ¨ å…‰ã‚’é›†ã‚ã‚‹",
                    "option_b": "ğŸŒ™ å…‰ã¨è©±ã™"
                }
            }
        },
        "endings": {
            "aa": {
                "story": "å‹é”ã¨æ¥½ã—ãéŠã‚“ã§ã€ã¿ã‚“ãªã§ç¬‘é¡”ã«ãªã‚Šã¾ã—ãŸã€‚",
                "lesson": "å‹æƒ…ã®å¤§åˆ‡ã•",
                "image_prompt": "Children playing happily together in a bright meadow"
            },
            "ab": {
                "story": "å„ªã—ããŠã‚„ã¤ã‚’åˆ†ã‘ã¦ã€ã¿ã‚“ãªãŒå¬‰ã—ããªã‚Šã¾ã—ãŸã€‚",
                "lesson": "åˆ†ã‘åˆã†ã“ã¨ã®å–œã³",
                "image_prompt": "Children sharing snacks under a beautiful tree"
            },
            "ba": {
                "story": "å…‰ã‚’é›†ã‚ã¦ç´ æ•µãªè™¹ã‚’ä½œã‚Šã€ä¸–ç•ŒãŒæ˜ã‚‹ããªã‚Šã¾ã—ãŸã€‚",
                "lesson": "åŠªåŠ›ã™ã‚‹ã“ã¨ã®ä¾¡å€¤",
                "image_prompt": "A magical rainbow created by gathering starlight"
            },
            "bb": {
                "story": "å…‰ã¨è©±ã—ã¦ç§˜å¯†ã‚’çŸ¥ã‚Šã€è³¢ããªã‚Šã¾ã—ãŸã€‚",
                "lesson": "å­¦ã¶ã“ã¨ã®æ¥½ã—ã•",
                "image_prompt": "A child talking to magical glowing lights in the forest"
            }
        }
    }
```

### 2. Vertex AI Imagen ã§ã®ç”»åƒç”Ÿæˆ

```python
# functions/image_generation.py
import functions_framework
import vertexai
from vertexai.preview.vision_models import ImageGenerationModel
from google.cloud import storage
import uuid
import json
import asyncio
import concurrent.futures

# Vertex AI åˆæœŸåŒ–
vertexai.init(project="your-project-id", location="us-central1")

@functions_framework.http
def generate_story_images(request):
    """4ã¤ã®çµæœ«ç”»åƒã‚’ä¸¦è¡Œç”Ÿæˆ"""
    
    headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST',
        'Access-Control-Allow-Headers': 'Content-Type',
    }
    
    if request.method == 'OPTIONS':
        return ('', 204, headers)
    
    try:
        request_json = request.get_json()
        story_data = request_json.get('story_data')
        session_id = request_json.get('session_id', str(uuid.uuid4()))
        
        # ä¸¦è¡Œç”»åƒç”Ÿæˆ
        image_results = generate_all_images_parallel(story_data, session_id)
        
        response = {
            'status': 'success',
            'session_id': session_id,
            'images': image_results
        }
        
        return (json.dumps(response), 200, headers)
        
    except Exception as e:
        error_response = {
            'status': 'error',
            'message': str(e),
            'fallback_images': get_fallback_images()
        }
        return (json.dumps(error_response), 500, headers)

def generate_all_images_parallel(story_data, session_id):
    """4ã¤ã®ç”»åƒã‚’ä¸¦è¡Œç”Ÿæˆ"""
    
    endings = story_data.get('endings', {})
    
    # ä¸¦è¡Œå®Ÿè¡Œã®ãŸã‚ã®ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ¼
    with concurrent.futures.ThreadPoolExecutor(max_workers=4) as executor:
        # å„çµæœ«ã®ç”»åƒç”Ÿæˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
        future_to_ending = {}
        
        for ending_key, ending_data in endings.items():
            future = executor.submit(
                generate_single_image,
                ending_key,
                ending_data.get('image_prompt', ''),
                session_id
            )
            future_to_ending[future] = ending_key
        
        # çµæœã‚’åé›†
        results = {}
        for future in concurrent.futures.as_completed(future_to_ending):
            ending_key = future_to_ending[future]
            try:
                image_url = future.result(timeout=60)  # 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                results[ending_key] = {
                    'status': 'success',
                    'image_url': image_url
                }
            except Exception as e:
                print(f"ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼ ({ending_key}): {e}")
                results[ending_key] = {
                    'status': 'error',
                    'error': str(e),
                    'fallback_url': get_fallback_image_url(ending_key)
                }
        
        return results

def generate_single_image(ending_key, base_prompt, session_id):
    """å˜ä¸€ã®ç”»åƒã‚’ç”Ÿæˆ"""
    
    try:
        # Imagen ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–
        model = ImageGenerationModel.from_pretrained("imagegeneration@006")
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–
        optimized_prompt = optimize_image_prompt(base_prompt)
        
        # ç”»åƒç”Ÿæˆ
        images = model.generate_images(
            prompt=optimized_prompt,
            number_of_images=1,
            aspect_ratio="4:3",
            safety_filter_level="block_most",
            person_generation="allow_adult"
        )
        
        if not images.images:
            raise Exception("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
        
        # Cloud Storage ã«ä¿å­˜
        image_url = save_image_to_storage(
            images.images[0], 
            session_id, 
            ending_key
        )
        
        return image_url
        
    except Exception as e:
        print(f"ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
        raise

def optimize_image_prompt(base_prompt):
    """å¹¼ç¨šåœ’å…å‘ã‘çµµæœ¬ã®ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ€é©åŒ–"""
    
    style_prefix = """
    Children's book illustration, watercolor style, soft pastel colors,
    friendly cartoon characters, warm and cozy atmosphere, 
    professional children's book quality, hand-drawn feel,
    """
    
    character_style = """
    Characters with big friendly eyes, round faces, simple design,
    expressive but not overly detailed, cute and approachable,
    """
    
    safety_guidelines = """
    G-rated content appropriate for ages 3-6, no scary elements, 
    no violence, no dark themes, bright and cheerful mood,
    educational and wholesome content, encouraging atmosphere,
    """
    
    technical_specs = """
    High quality digital art, clean composition, balanced colors,
    suitable for children's book printing, vibrant but not overwhelming,
    """
    
    optimized_prompt = f"{style_prefix} {character_style} {base_prompt} {safety_guidelines} {technical_specs}"
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·åˆ¶é™
    if len(optimized_prompt) > 1000:
        optimized_prompt = optimized_prompt[:950] + "..."
    
    return optimized_prompt

def save_image_to_storage(image, session_id, ending_key):
    """ç”Ÿæˆç”»åƒã‚’Cloud Storageã«ä¿å­˜"""
    
    try:
        # Cloud Storage ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        client = storage.Client()
        bucket = client.bucket("your-storybook-images")
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
        filename = f"story_{session_id}_{ending_key}_{uuid.uuid4().hex[:8]}.png"
        blob_path = f"generated_images/{filename}"
        
        # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        blob = bucket.blob(blob_path)
        blob.upload_from_string(
            image._image_bytes,
            content_type='image/png'
        )
        
        # å…¬é–‹URLè¨­å®š
        blob.make_public()
        public_url = blob.public_url
        
        print(f"ç”»åƒä¿å­˜å®Œäº†: {public_url}")
        return public_url
        
    except Exception as e:
        print(f"ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        raise Exception(f"ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

def get_fallback_images():
    """ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒURL"""
    
    return {
        'aa': 'https://storage.googleapis.com/your-storybook-images/fallback/happy_ending_1.png',
        'ab': 'https://storage.googleapis.com/your-storybook-images/fallback/happy_ending_2.png',
        'ba': 'https://storage.googleapis.com/your-storybook-images/fallback/happy_ending_3.png',
        'bb': 'https://storage.googleapis.com/your-storybook-images/fallback/happy_ending_4.png'
    }

def get_fallback_image_url(ending_key):
    """ç‰¹å®šã®çµæœ«ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒ"""
    
    fallback_images = get_fallback_images()
    return fallback_images.get(ending_key, fallback_images['aa'])
```

### 3. åŠ¹ç‡çš„ãªä¸¦è¡Œå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

```python
# functions/story_orchestrator.py
import functions_framework
import asyncio
import aiohttp
import json
from concurrent.futures import ThreadPoolExecutor
import time

@functions_framework.http
def create_complete_storybook(request):
    """ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆã¨ç”»åƒç”Ÿæˆã‚’ä¸¦è¡Œå®Ÿè¡Œ"""
    
    headers = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST',
        'Access-Control-Allow-Headers': 'Content-Type',
    }
    
    if request.method == 'OPTIONS':
        return ('', 204, headers)
    
    try:
        request_json = request.get_json()
        user_topic = request_json.get('topic')
        
        # ä¸¦è¡Œå‡¦ç†ã§åŠ¹ç‡çš„ãªçµµæœ¬ä½œæˆ
        result = run_parallel_storybook_creation(user_topic)
        
        return (json.dumps(result, ensure_ascii=False), 200, headers)
        
    except Exception as e:
        error_response = {
            'status': 'error',
            'message': str(e)
        }
        return (json.dumps(error_response), 500, headers)

def run_parallel_storybook_creation(user_topic):
    """ä¸¦è¡Œå‡¦ç†ã§ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ–ãƒƒã‚¯ä½œæˆ"""
    
    start_time = time.time()
    
    # Step 1: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆï¼ˆå„ªå…ˆå®Ÿè¡Œï¼‰
    print("ğŸ“– ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆé–‹å§‹...")
    story_data = generate_story_sync(user_topic)
    story_time = time.time()
    
    # Step 2: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å®Œæˆã¨åŒæ™‚ã«ç”»åƒç”Ÿæˆé–‹å§‹
    print("ğŸ¨ ç”»åƒç”Ÿæˆé–‹å§‹...")
    with ThreadPoolExecutor(max_workers=4) as executor:
        image_futures = {}
        
        for ending_key, ending_data in story_data['endings'].items():
            future = executor.submit(
                generate_image_sync,
                ending_key,
                ending_data['image_prompt']
            )
            image_futures[ending_key] = future
        
        # ç”»åƒç”Ÿæˆå®Œäº†ã‚’å¾…æ©Ÿ
        image_results = {}
        for ending_key, future in image_futures.items():
            try:
                image_url = future.result(timeout=45)  # 45ç§’åˆ¶é™
                image_results[ending_key] = {
                    'status': 'success',
                    'url': image_url
                }
                print(f"âœ… ç”»åƒå®Œæˆ: {ending_key}")
            except Exception as e:
                print(f"âŒ ç”»åƒç”Ÿæˆå¤±æ•—: {ending_key} - {e}")
                image_results[ending_key] = {
                    'status': 'error',
                    'fallback_url': get_fallback_image_url(ending_key)
                }
    
    total_time = time.time() - start_time
    
    return {
        'status': 'success',
        'story_data': story_data,
        'images': image_results,
        'performance': {
            'story_generation_time': round(story_time - start_time, 2),
            'total_time': round(total_time, 2),
            'parallel_efficiency': True
        }
    }

# ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ 
class ProgressTracker:
    def __init__(self):
        self.progress = {
            'story': 0,
            'images': {'aa': 0, 'ab': 0, 'ba': 0, 'bb': 0}
        }
    
    def update_story_progress(self, percentage):
        self.progress['story'] = percentage
        self.notify_client()
    
    def update_image_progress(self, ending_key, percentage):
        self.progress['images'][ending_key] = percentage
        self.notify_client()
    
    def notify_client(self):
        # WebSocket ã¾ãŸã¯ Server-Sent Events ã§é€²æ—é€šçŸ¥
        # å®Ÿè£…ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦ä»¶ã«å¿œã˜ã¦
        pass
```

## ğŸ–¥ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 4. React/TypeScript ã§ã®çµ±åˆ

```typescript
// hooks/useAIStorybook.ts
import { useState, useEffect } from 'react';

interface StoryData {
  title: string;
  introduction: string;
  first_choice: Choice;
  branches: { [key: string]: Branch };
  endings: { [key: string]: Ending };
}

interface Choice {
  situation: string;
  option_a: string;
  option_b: string;
}

interface Branch {
  story: string;
  second_choice: Choice;
}

interface Ending {
  story: string;
  lesson: string;
  image_prompt: string;
}

interface ImageResult {
  status: 'generating' | 'completed' | 'error';
  url?: string;
  progress: number;
}

export const useAIStorybook = () => {
  const [storyData, setStoryData] = useState<StoryData | null>(null);
  const [images, setImages] = useState<{ [key: string]: ImageResult }>({});
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const createStorybook = async (topic: string) => {
    setIsGenerating(true);
    setError(null);
    
    try {
      // Step 1: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆ
      const storyResponse = await fetch('/api/generate-story', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic })
      });
      
      if (!storyResponse.ok) {
        throw new Error('ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      const storyData = await storyResponse.json();
      setStoryData(storyData);
      
      // Step 2: ç”»åƒç”Ÿæˆã‚’ä¸¦è¡Œé–‹å§‹
      generateImagesInBackground(storyData);
      
    } catch (err) {
      setError(err instanceof Error ? err.message : 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setIsGenerating(false);
    }
  };

  const generateImagesInBackground = async (storyData: StoryData) => {
    const endings = Object.keys(storyData.endings);
    
    // åˆæœŸåŒ–
    const initialImages = endings.reduce((acc, key) => ({
      ...acc,
      [key]: { status: 'generating' as const, progress: 0 }
    }), {});
    setImages(initialImages);
    
    // ä¸¦è¡Œç”»åƒç”Ÿæˆ
    const imagePromises = endings.map(async (endingKey) => {
      try {
        const response = await fetch('/api/generate-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ending_key: endingKey,
            prompt: storyData.endings[endingKey].image_prompt
          })
        });
        
        if (!response.ok) {
          throw new Error('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const result = await response.json();
        
        setImages(prev => ({
          ...prev,
          [endingKey]: {
            status: 'completed',
            url: result.image_url,
            progress: 100
          }
        }));
        
      } catch (error) {
        console.error(`ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${endingKey}):`, error);
        setImages(prev => ({
          ...prev,
          [endingKey]: {
            status: 'error',
            progress: 100
          }
        }));
      }
    });
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    simulateImageProgress(endings);
    
    await Promise.allSettled(imagePromises);
  };

  const simulateImageProgress = (endings: string[]) => {
    endings.forEach(endingKey => {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15 + 5;
        
        if (progress >= 95) {
          clearInterval(interval);
          return;
        }
        
        setImages(prev => ({
          ...prev,
          [endingKey]: {
            ...prev[endingKey],
            progress: Math.min(progress, 95)
          }
        }));
      }, 500);
    });
  };

  return {
    storyData,
    images,
    isGenerating,
    error,
    createStorybook
  };
};
```

### 5. Vue.js Composition API å®Ÿè£…

```typescript
// composables/useAIStorybook.ts
import { ref, reactive } from 'vue';

export const useAIStorybook = () => {
  const storyData = ref(null);
  const images = reactive({});
  const isGenerating = ref(false);
  const error = ref(null);
  
  const createStorybook = async (topic: string) => {
    isGenerating.value = true;
    error.value = null;
    
    try {
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆã¨ç”»åƒç”Ÿæˆã®ä¸¦è¡Œå‡¦ç†
      const [storyResult] = await Promise.all([
        generateStory(topic),
        // ç”»åƒç”Ÿæˆã¯éåŒæœŸã§é–‹å§‹
        new Promise(resolve => {
          setTimeout(() => {
            generateImages().then(resolve);
          }, 1000);
        })
      ]);
      
      storyData.value = storyResult;
      
    } catch (err) {
      error.value = err.message;
    } finally {
      isGenerating.value = false;
    }
  };
  
  const generateStory = async (topic: string) => {
    const response = await fetch('/api/story-generation', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ topic })
    });
    
    return response.json();
  };
  
  const generateImages = async () => {
    if (!storyData.value) return;
    
    const endings = Object.keys(storyData.value.endings);
    
    endpoints.forEach(async (ending) => {
      images[ending] = { status: 'generating', progress: 0 };
      
      try {
        const imageUrl = await generateSingleImage(ending);
        images[ending] = { status: 'completed', url: imageUrl, progress: 100 };
      } catch (error) {
        images[ending] = { status: 'error', progress: 100 };
      }
    });
  };
  
  return {
    storyData,
    images,
    isGenerating,
    error,
    createStorybook
  };
};
```

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€Gemini ADKã§é«˜å“è³ªãªã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç”Ÿæˆã—ã€Vertex AIã§ç¾ã—ã„ç”»åƒã‚’ä¸¦è¡Œä½œæˆã™ã‚‹ã“ã¨ã§ã€å­ä¾›ãŸã¡ãŒå¾…ã¤ã“ã¨ãªãæ¥½ã—ã‚ã‚‹åŠ¹ç‡çš„ãªçµµæœ¬ä½œæˆã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã§ãã¾ã™ï¼
